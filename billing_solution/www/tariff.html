<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tariff Page</title>
    <link rel="stylesheet" href="/assets/billing_solution/css/tariff.css">
</head>
<body style="background-color: #eef3f8;">

{% extends "templates/web.html" %}
{% block page_content %}

{% include "billing_solution/templates/includes/navbar.html" %}

<style>
    /* Hide default Frappe elements */
    .navbar.navbar-light.navbar-expand-lg {
        display: none !important;
    }
    
    .navbar, .page-header, footer {
        display: none !important;
    }
    
    .navbar-expand-lg.navbar-light.bg-white.shadow-sm {
        display: block !important;
    }

    /* Custom styles */
    .form-control, .form-select {
        border-radius: 6px;
        border: 1px solid #dee2e6;
        padding: 0.5rem 0.75rem;
        height: 38px;
    }

    .form-control:focus, .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    /* Disable spinners for specific inputs */
    input[type="number"].no-spinners::-webkit-inner-spin-button,
    input[type="number"].no-spinners::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    input[type="number"].no-spinners {
        -moz-appearance: textfield;
    }

    /* Table styles */
    .table tbody tr {
        cursor: pointer;
    }

    .table tbody tr:hover {
        background-color: rgba(0,0,0,0.075);
    }
</style>

<div class="container-fluid p-3 p-md-4">
    <div class="card shadow-sm rounded-4">
        <div class="card-header d-flex justify-content-between align-items-center p-3 rounded-top-4" style="background-color: #262626;">
            <h5 class="text-white mb-0">Tariff</h5>
            <button class="btn btn-sm btn-outline-light rounded-3" id="saveTariff">Save</button>
        </div>
        
        <div class="card-body px-3 px-md-4 py-4">
            <div class="row g-3">
                <!-- Customer Type -->
                <div class="col-12">
                    <div class="row align-items-center">
                        <label class="col-12 col-md-3 col-form-label">Customer Type</label>
                        <div class="col-12 col-md-4 col-lg-3">
                            <select class="form-select" id="customerType" data-fieldname="customer_type">
                                <option value="DOMESTIC">Domestic</option>
                                <option value="COMMERCIAL">Commercial</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Fixed Charge -->
                <div class="col-12">
                    <div class="row align-items-center">
                        <label class="col-12 col-md-3 col-form-label">Fixed Charge</label>
                        <div class="col-12 col-md-4 col-lg-3">
                            <input type="number" class="form-control no-spinners" value="90" data-fieldname="fixed_charge">
                        </div>
                    </div>
                </div>

                <!-- From Unit - To Unit Row -->
                <div class="col-12">
                    <div class="row align-items-center">
                        <label class="col-12 col-md-3 col-form-label">From Unit</label>
                        <div class="col-12 col-md-3">
                            <input type="number" class="form-control bg-light" value="0" data-fieldname="from_unit" readonly>
                        </div>
                        <label class="col-12 col-md-2 col-form-label text-md-center">To Unit</label>
                        <div class="col-12 col-md-3">
                            <input type="number" class="form-control" data-fieldname="to_unit">
                        </div>
                    </div>
                </div>

                <!-- Tariff Row -->
                <div class="col-12">
                    <div class="row align-items-center">
                        <label class="col-12 col-md-3 col-form-label">Tariff</label>
                        <div class="col-12 col-md-3">
                            <input type="number" class="form-control" data-fieldname="tariff">
                            <span class="text-muted gap-2" style="font-size: 13px;">Amount</span>
                        </div>
                        <div class="col-12 col-md-2 text-md-center" style="width:30px;">/</div>
                        <div class="col-12 col-md-3">
                            <input type="number" class="form-control" data-fieldname="per_unit">
                            <span class="text-muted gap-2" style="font-size: 13px;">Unit</span>
                        </div>
                    </div>
                </div>

                <!-- Hidden Basic Amount -->
                <input type="hidden" data-fieldname="basic_amount" value="0">

                <!-- Overdue Fine Row -->
                <div class="col-12">
                    <div class="row align-items-center">
                        <label class="col-12 col-md-3 col-form-label">Fixed Fine After Due Date</label>
                        <div class="col-12 col-md-4 col-lg-3">
                            <input type="number" class="form-control no-spinners" data-fieldname="overdue_fine">
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="col-12">
                    <div class="d-flex flex-wrap gap-2 mt-3">
                        <button class="btn text-danger" onclick="clearTariffTable()">Delete</button>
                        <button class="btn text-muted" onclick="clearInputs()">Clear</button>
                        <button class="btn" onclick="addTariffRow()">Add</button>
                    </div>
                </div>
            </div>

            <!-- Table Section -->
            <div class="mt-4">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center" style="width: 80px">SL No.</th>
                                <th>From Unit</th>
                                <th>To Unit</th>
                                <th>Tariff</th>
                                <th>Per Unit</th>
                                <th>Basic Amount</th>
                                <th>Total Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Your existing JavaScript code here
let tariffRows = [];

function addTariffRow() {
    const fromUnit = parseFloat(document.querySelector('[data-fieldname="from_unit"]').value) || 0;
    const toUnit = parseFloat(document.querySelector('[data-fieldname="to_unit"]').value) || 0;
    const tariff = parseFloat(document.querySelector('[data-fieldname="tariff"]').value) || 0;
    const perUnit = parseFloat(document.querySelector('[data-fieldname="per_unit"]').value) || 0;

    // Validation
    if (toUnit <= fromUnit) {
        frappe.throw('To Unit must be greater than From Unit');
        return;
    }
    if (tariff <= 0 || perUnit <= 0) {
        frappe.throw('Tariff and Per Unit values must be greater than 0');
        return;
    }

    const basicAmount = tariffRows.length > 0 ? tariffRows[tariffRows.length - 1].totalAmount : 0;
    const unitsInRange = toUnit - fromUnit;
    const tariffAmount = (unitsInRange / perUnit) * tariff;
    const totalAmount = basicAmount + tariffAmount;

    tariffRows.push({
        slNo: tariffRows.length + 1,
        fromUnit,
        toUnit,
        tariff,
        perUnit,
        basicAmount,
        totalAmount
    });

    updateTariffTable();
    setupNextRow(toUnit, totalAmount);
    clearInputs();
}

function updateTariffTable() {
    const tbody = document.querySelector('table tbody');
    tbody.innerHTML = '';
    
    tariffRows.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="text-center">${row.slNo}</td>
            <td>${row.fromUnit}</td>
            <td>${row.toUnit}</td>
            <td>${row.tariff}</td>
            <td>${row.perUnit}</td>
            <td>${row.basicAmount.toFixed(2)}</td>
            <td>${row.totalAmount.toFixed(2)}</td>
        `;
        tr.addEventListener('click', () => deleteTariffRow(index));
        tbody.appendChild(tr);
    });
}

function setupNextRow(previousToUnit, previousTotal) {
    document.querySelector('[data-fieldname="from_unit"]').value = previousToUnit;
    document.querySelector('[data-fieldname="basic_amount"]').value = previousTotal.toFixed(2);
}

function clearInputs() {
    document.querySelector('[data-fieldname="to_unit"]').value = '';
    document.querySelector('[data-fieldname="tariff"]').value = '';
    document.querySelector('[data-fieldname="per_unit"]').value = '';
}

function clearTariffTable() {
    tariffRows = [];
    updateTariffTable();
    document.querySelector('[data-fieldname="from_unit"]').value = '0';
    clearInputs();
}

function deleteTariffRow(index) {
    if (!confirm('Are you sure you want to delete this row?')) return;
    
    tariffRows.splice(index, 1);
    
    tariffRows.forEach((row, idx) => {
        row.slNo = idx + 1;
        row.basicAmount = idx > 0 ? tariffRows[idx - 1].totalAmount : 0;
        row.totalAmount = row.basicAmount + ((row.toUnit - row.fromUnit) / row.perUnit) * row.tariff;
    });
    
    updateTariffTable();
}

// Initialize the table
document.addEventListener('DOMContentLoaded', function() {
    updateTariffTable();
});
</script>

{% endblock %}

</body>
</html>